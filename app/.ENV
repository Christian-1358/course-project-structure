# ARQUIVO: .env

# Chaves de API do Google OAuth 2.0 (Valores confirmados no seu Google Cloud Console)
GOOGLE_CLIENT_ID="899997122020-0v0hokvnet5l9nnt1cufg071tbq60rdc.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="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"

# Segredo de cookie principal para o Tornado (Escolha um valor forte ou use secrets.token_urlsafe(32) no código)
TORNADO_COOKIE_SECRET="seu_segredo_unico_de_40_caracteres"

import tornado.web
import tornado.auth
import sqlite3
import hashlib
import uuid
import os
from tornado.web import RequestHandler

from app.utils.admin_tools import listar_usuarios


BASE_DIR = os.path.dirname(
    os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
)
DB_PATH = os.path.join(BASE_DIR, "usuarios.db")


def conectar():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn


def hash_senha(text: str) -> str:
    return hashlib.sha256(text.encode("utf-8")).hexdigest()


def criar_tabela():
    conn = conectar()
    c = conn.cursor()
    c.execute("""
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password TEXT NOT NULL,
            email TEXT UNIQUE
        )
    """)
    conn.commit()
    conn.close()

class LoginHandler(tornado.web.RequestHandler):
    def get(self):
        self.render(
            "login.html",
            erro=None,
            mensagem=None,
            usuario_prefill=""
        )

    def post(self):
        criar_tabela()

        username = self.get_argument("username", "").strip()
        password = self.get_argument("password", "").strip()

        # ATALHO DEV (somente para desenvolvedores)
        if username == "dev" and password == "dev":
            self.redirect("/login_dev")
            return

        if not username or not password:
            self.render(
                "login.html",
                erro="Preencha todos os campos",
                mensagem=None,
                usuario_prefill=username
            )
            return

        senha_hash = hash_senha(password)

        conn = conectar()
        c = conn.cursor()
        c.execute("""
            SELECT id, username
            FROM users
            WHERE username=? AND password=?
        """, (username, senha_hash))
        user = c.fetchone()
        conn.close()

        if not user:
            self.render(
                "login.html",
                erro="Usuário ou senha inválidos",
                mensagem=None,
                usuario_prefill=username
            )
            return

        self.set_secure_cookie("user", user["username"])
        self.set_secure_cookie("user_id", str(user["id"]))
        self.redirect("/curso")




# No admin_tools.py:
class LoginDevHandler(tornado.web.RequestHandler):
    def get(self):
        usuarios = listar_usuarios()
        self.render(
            "painel_dev.html",
            usuarios=usuarios,
            mensagem=None,
            erro=None
        )


class GoogleLoginHandler(
    tornado.web.RequestHandler,
    tornado.auth.GoogleOAuth2Mixin
):
    async def get(self):
        criar_tabela()

        if self.get_argument("code", False):

            token = await self.get_authenticated_user(
                redirect_uri="http://localhost:8080/auth/google",
                code=self.get_argument("code")
            )

            if not token:
                self.redirect("/login")
                return

            user_info = await self.oauth2_request(
                "https://www.googleapis.com/oauth2/v2/userinfo",
                access_token=token["access_token"]
            )

            email = user_info.get("email")
            name = user_info.get("name", "")

            if not email:
                self.write("Erro: Google não retornou o e-mail.")
                return

            username = email.split("@")[0]

            conn = conectar()
            c = conn.cursor()

            c.execute("SELECT id FROM users WHERE email=?", (email,))
            row = c.fetchone()

            if not row:
                fake_password = hash_senha(str(uuid.uuid4()))
                c.execute(
                    "INSERT INTO users (username, password, email) VALUES (?, ?, ?)",
                    (username, fake_password, email)
                )
                user_id = c.lastrowid
            else:
                user_id = row[0]

            conn.commit()
            conn.close()

            self.set_secure_cookie("user", username)
            self.set_secure_cookie("user_id", str(user_id))

            self.redirect("/curso")

        else:
            self.authorize_redirect(
                redirect_uri="http://localhost:8080/auth/google",
                client_id=self.settings["google_oauth"]["key"],
                scope=["openid", "email", "profile"],
                response_type="code",
                extra_params={"prompt": "select_account"}
            )

class LogoutHandler(tornado.web.RequestHandler):
    def get(self):
        self.clear_cookie("user")
        self.clear_cookie("user_id")
        self.redirect("/login")










curso: 









        <link rel="stylesheet" href="/static/css/curso.css">

    <script src="{{ static_url('js/curso.js') }}"></script>
